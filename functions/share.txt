const { onRequest } = require("firebase-functions/v2/https");
const { onSchedule } = require("firebase-functions/v2/scheduler");
const { onDocumentCreated } = require("firebase-functions/v2/firestore");
const admin = require('firebase-admin');
const { logger } = require("firebase-functions");
const { onCreate } = require("firebase-functions/v2/auth");



const firebaseConfig = {
  apiKey: "AIzaSyBzWet0XpZmr7UcQIspxLUEZKUpq39qfGo",
  authDomain: "didactic-chainsaw.firebaseapp.com",
  projectId: "didactic-chainsaw",
  storageBucket: "didactic-chainsaw.firebasestorage.app",
  messagingSenderId: "551313371102",
  appId: "1:551313371102:web:55d89f457deba62882f74f"
};

admin.initializeApp(firebaseConfig);

const db = admin.firestore();
const collectionName = "users";

exports.writeUser = onRequest(async (request, response) => {
    const newUser = {
      name: 'Jane Doe',
      email: 'jane@example.com',
      age: 28,
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    };

    const docRef = await db.collection(collectionName).add(newUser);
    const userID = docRef.id;

    response.send(`CREATE: Document created with ID: ${userID}`)
})

exports.readUser = onRequest( async (request, response)=>{
    const docRef = await db.collection(collectionName).doc("6hZqLTm7UMOCvasmEv0E");
    docRef.get().then(doc=>{
        if(doc.exists){
            response.send(doc);
        }
    })
})

exports.updateUser = onRequest( async (request, response)=>{
    await db.collection(collectionName).doc("6hZqLTm7UMOCvasmEv0E").update({
        age: 29,
        lastUpdated: admin.firestore.FieldValue.serverTimestamp()
    })
    response.send("Updated age to 29.")
})

exports.queryUser = onRequest( async (request, response)=>{
    const snapshot = await db.collection(collectionName).where('age', '>', 25).get();
    var str = ""
    if (snapshot.empty){
        response.send("No matching Docs")

    }
    else{
        snapshot.forEach(doc=>{
            str += ` - ${doc.id} => ${doc.data().name} (Age: ${doc.data().age})`
            
        })
        response.send(str);
    }
})

//THIS IS THE SCHEDULER
exports.nightlyCleanup = onSchedule("0 0 * * *", async (event) => {
    logger.info("Running nightly cleanup at midnight.")
})

//EXAMPLE
exports.onUserBioCreated = onDocumentCreated("user/{userID}/bios/{bioID}", aysnc (event) => {
    const snapshot = event.data

    if (!snapshot) return;

    const data = snapshot.data();
    const uderID = event.params.userID;

    logger.info(`New Bio Created ${userID}: ${data.content}`)
})

exports.welcomeNewUser = onCreate((user) => {
    const email = user.email;
    const displayName = user.displayName || "New User";

    logger.info(`User ${user.uid} signed up with email: ${email}`)
})